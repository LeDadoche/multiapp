<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- Anti-FOUC: cache le contenu jusqu'√† ce que CSS + fonts soient pr√™tes -->
  <style>html.fouc-guard body{visibility:hidden}</style>
  <script>
    document.documentElement.classList.add('fouc-guard');
    // Prefer removing the guard on 'load' but also unguard on DOMContentLoaded or after a timeout
    function removeFoucGuard(){ try{ document.documentElement.classList.remove('fouc-guard'); }catch(e){} }
    window.addEventListener('load', removeFoucGuard, { once:true });
    document.addEventListener('DOMContentLoaded', removeFoucGuard, { once:true });
    // Fallback: don't hide UI for more than 3s even if external fonts are slow or blocked
    setTimeout(removeFoucGuard, 3000);
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Assistant personnel</title>

  <!-- üîí Bootstrap de th√®me AVANT toute CSS pour √©viter le flash -->
  <script>
  (function () {
    try {
      var saved = localStorage.getItem('theme');
      if (!saved) {
        saved = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        localStorage.setItem('theme', saved);
      }
      if (saved === 'dark') {
        // on met la classe sur <html> (et ce sera pris par le CSS)
        document.documentElement.classList.add('dark-mode');
      }
    } catch (e) {}
  })();
  </script>

  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <!-- Google OAuth Client ID (public). Mets ici TON ID une seule fois. -->
  <meta name="google-client-id" content="226062651667-fdqb383hnrb14dpj5rf4rup4epbgbtsd.apps.googleusercontent.com">
  <style>
    /* Forcer l‚Äôoverlay √† occuper tout l‚Äô√©cran et le panneau √† s‚Äôafficher */
    #icon-sheet{position:fixed; inset:0; display:none; z-index:4000;}
    #icon-sheet.is-open{display:block;}
    #icon-sheet .sheet__backdrop{position:absolute; inset:0; background:rgba(0,0,0,.45);}
    #icon-sheet .sheet__panel{
      position:absolute; left:0; right:0; bottom:0;
      background:#fff; border-radius:16px 16px 0 0;
      max-height:88vh; overflow:auto;
      /* Pas d‚Äôanimation tant que √ßa ne s‚Äôaffiche pas correctement */
      transform:translateY(0);
    }
  </style>
  <!-- Ic√¥nes (CORS friendly) -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">

  <!-- Material Icons -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
        crossorigin="anonymous">
  <!-- Dropbox JS SDK -->
  <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <!-- Plotly.js 3.0.3 (derni√®re stable 3.x au moment o√π j‚Äô√©cris) -->
  <script src="https://cdn.plot.ly/plotly-3.0.3.min.js"></script>
</head>

<body>
<header class="site-header">
  <!-- En-t√™te principal de l'application multi-services -->
  <div class="topbar">
    <h1>Assistant personnel</h1>

    <!-- Menu Profil / R√©glages (UN SEUL BLOC) -->
    <div class="profile-menu" style="position:fixed; top:12px; right:12px; z-index:5000;">
      <!-- Bouton d'ouverture du menu profil -->
      <button class="profile-trigger" id="profileBtn" aria-expanded="false" aria-controls="profileDropdown" title="Profil & R√©glages">
        <i class="fa-solid fa-user-gear"></i>
      </button>

      <!-- Contenu du menu profil (dropdown) -->
    <div class="profile-dropdown" id="profileDropdown" role="menu" aria-hidden="true"
              style="display:none; position:fixed; top:46px; right:12px; z-index:5001;">
      <div class="menu-section">
        <div class="menu-title">Cloud & synchronisation</div>

        <!-- Dossier local -->
        <div class="service-row">
          <div class="service-head">
            <i class="fa-solid fa-folder"></i>
            <span>Dossier local</span>
            <span class="service-status unsupported" id="folder-status">Non support√© par ce navigateur</span>
          </div>
          <div class="service-actions">
            <button id="pick-folder-btn">Choisir le dossier‚Ä¶</button>
            <button id="clear-folder-btn" style="display:none;">Oublier</button>
          </div>
        </div>

        <!-- Dropbox -->
        <div class="service-row">
          <div class="service-head">
            <i class="fa-brands fa-dropbox"></i>
            <span>Dropbox</span>
            <button id="dropbox-config" class="config-btn" title="Configurer Dropbox" aria-label="Configurer Dropbox">
              <i class="fa-solid fa-gear" aria-hidden="true"></i>
            </button>
            <span class="service-status" id="dropbox-status">‚Ä¶</span>
          </div>
          <div class="service-actions">
            <button id="dropbox-login" class="dropbox-btn">Se connecter</button>
            <button id="dropbox-logout" class="dropbox-btn" style="display:none;">Se d√©connecter</button>
          </div>
        </div>

        <!-- Google Drive -->
        <div class="service-row">
          <div class="service-head">
            <i class="fa-brands fa-google-drive"></i>
            <span>Google Drive</span>
            <button id="google-config" class="config-btn" title="Configurer Google Drive" aria-label="Configurer Google Drive">
              <i class="fa-solid fa-gear" aria-hidden="true"></i>
            </button>
            <span class="service-status" id="google-status">‚Ä¶</span>
          </div>
          <div class="service-actions">
            <button id="google-login">Se connecter</button>
            <button id="google-logout" style="display:none;">Se d√©connecter</button>
          </div>
        </div>

        <!-- Microsoft OneDrive -->
        <div class="service-row">
          <div class="service-head">
            <i class="fa-brands fa-microsoft"></i>
            <span>OneDrive</span>
            <button id="ms-config" class="config-btn" title="Configurer OneDrive" aria-label="Configurer OneDrive">
              <i class="fa-solid fa-gear" aria-hidden="true"></i>
            </button>
            <span class="service-status" id="ms-status">‚Ä¶</span>
          </div>
          <div class="service-actions">
            <button id="ms-login">Se connecter</button>
            <button id="ms-logout" style="display:none;">Se d√©connecter</button>
          </div>
        </div>
      </div><!-- /.menu-section -->

      <!-- ‚úÖ SECTION : Apparence & pr√©f√©rences -->
      <div class="menu-section prefs-section">
        <div class="menu-title">Apparence & pr√©f√©rences</div>

        <!-- Groupe : Th√®me clair / sombre -->
        <div class="prefs-group">
          <div class="prefs-row">
            <div class="prefs-label">Th√®me</div>
            <button class="theme-toggle" id="themeToggle" aria-pressed="false" aria-label="Basculer clair/sombre">
              <span class="tt-track" aria-hidden="true"></span>
              <span class="tt-knob" aria-hidden="true">
                <svg class="tt-sun" viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="12" cy="12" r="5"></circle>
                  <g class="rays">
                    <line x1="12" y1="1.5" x2="12" y2="4.5"></line>
                    <line x1="12" y1="19.5" x2="12" y2="22.5"></line>
                    <line x1="1.5" y1="12" x2="4.5" y2="12"></line>
                    <line x1="19.5" y1="12" x2="22.5" y2="12"></line>
                    <line x1="4.2" y1="4.2" x2="6.3" y2="6.3"></line>
                    <line x1="17.7" y1="17.7" x2="19.8" y2="19.8"></line>
                    <line x1="17.7" y1="6.3" x2="19.8" y2="4.2"></line>
                    <line x1="4.2" y1="19.8" x2="6.3" y2="17.7"></line>
                  </g>
                </svg>
                <svg class="tt-moon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
              </span>
            </button>
          </div>
        </div>

        <!-- Groupe : Jauge de d√©couvert (activation g√©n√©rale) -->
        <div class="prefs-group">
          <label class="od-alert-row">
            <input id="od-enabled" type="checkbox" checked>
            <span>Afficher la jauge de d√©couvert dans l‚Äôonglet Calendrier</span>
          </label>
          <small class="od-help">D√©coche si tu pr√©f√®res masquer cette jauge.</small>
        </div>

        <!-- Groupe : Droit de d√©couvert -->
        <div class="prefs-group">
          <label for="od-limit" class="prefs-label"><i class="fa-solid fa-piggy-bank" style="margin-right:.4em;"></i>Droit de d√©couvert (EUR)</label>
          <div class="od-input-wrap">
            <input id="od-limit" type="number" inputmode="decimal" step="0.01" min="0" placeholder="Ex. 200,00" class="od-input">
            <span class="od-suffix">‚Ç¨</span>
          </div>

          <label class="od-alert-row">
            <input id="od-alerts" type="checkbox">
            <span>Activer l‚Äôalerte en cas de d√©passement</span>
          </label>

          <small class="od-help">La jauge se met √† jour selon ton solde et la limite choisie.</small>
        </div>

        <!-- Groupe : Couleur du bandeau -->
        <div class="prefs-group">
          <div class="prefs-label"><i class="fa-solid fa-palette" style="margin-right:.4em;"></i>Couleur du bandeau</div>
          <div class="swatch-list" id="topbar-color-swatches" aria-label="Choisir une couleur de bandeau">
            <button class="swatch-btn" data-color="#65b8f7" style="--sw:#65b8f7;" aria-label="Bleu"></button>
            <button class="swatch-btn" data-color="#7c4dff" style="--sw:#7c4dff;" aria-label="Violet"></button>
            <button class="swatch-btn" data-color="#00bfa5" style="--sw:#00bfa5;" aria-label="Turquoise"></button>
            <button class="swatch-btn" data-color="#43a047" style="--sw:#43a047;" aria-label="Vert"></button>
            <button class="swatch-btn" data-color="#546e7a" style="--sw:#546e7a;" aria-label="Bleu gris"></button>
            <button class="swatch-btn" data-color="#ff7043" style="--sw:#ff7043;" aria-label="Orange"></button>
            <button class="swatch-btn" data-color="#ef5350" style="--sw:#ef5350;" aria-label="Rouge"></button>
            <label class="custom-color" title="Couleur personnalis√©e">
              <input type="color" id="topbar-color-input" value="#65b8f7" aria-label="Couleur personnalis√©e du bandeau">
              <span>Perso‚Ä¶</span>
            </label>
          </div>
        </div>
      </div><!-- /.menu-section -->
    </div><!-- /.profile-dropdown -->
  </div><!-- /.topbar -->

  <!-- Navigation des modules de la multi-application -->
  <nav class="app-nav" aria-label="Navigation des modules">
    <button class="app-btn active" data-app="finance"><i class="fa-solid fa-coins"></i> Finance</button>
    <button class="app-btn" data-app="agenda"><i class="fa-solid fa-calendar"></i> Agenda</button>
    <button class="app-btn" data-app="courses"><i class="fa-solid fa-cart-shopping"></i> Courses</button>
    <button class="app-btn" data-app="gamelles"><i class="fa-solid fa-bone"></i> Gamelles</button>
    <button class="app-btn" data-app="taches"><i class="fa-solid fa-list-check"></i> T√¢ches</button>
    <button class="app-btn" data-app="sante"><i class="fa-solid fa-heart-pulse"></i> Sant√©</button>
  </nav>
</header>


  <main>
    <!-- Section Finances : le contenu existant est encapsul√© dans une section d√©di√©e -->
    <div id="app-finance" class="app-section" style="display:block;">
      <div class="main-container">
      <nav class="tabs">
        <button class="tab-btn active" data-tab="tab-transactions">Transactions</button>
        <button class="tab-btn" data-tab="tab-stats">Statistiques</button>
        <button class="tab-btn" data-tab="tab-history">Historique</button>
      </nav>
      <!-- Onglet Transactions -->
      <div id="tab-transactions" class="tab-content" style="display:block;">
        <section id="form-section">
          <h2>Nouvelle transaction</h2>
          <form id="transaction-form" autocomplete="off">
            <div class="form-row">
              <label for="type">Type :</label>
              <select id="type" required>
                <option value="expense">D√©pense</option>
                <option value="income">Revenu</option>
              </select>
            </div>

            <div class="form-row">
              <label for="date">Date :</label>
              <input type="text" id="date" class="date-input" placeholder="jj-mm-aaaa" required />
            </div>

            <div class="form-row">
              <label for="recurrence">R√©currence :</label>
              <select id="recurrence">
                <option value="none">Aucune</option>
                <option value="monthly">Mensuelle</option>
                <option value="yearly">Annuelle</option>
                <option value="installments">Paiement en X fois</option>
              </select>
            </div>
            <div class="form-row" id="recurrence-end-row" style="display:none;">
              <label for="recurrence-end">Jusqu‚Äô√† :</label>
              <input type="text" id="recurrence-end" class="date-input" placeholder="jj-mm-aaaa" />
            </div>

            <div class="form-row" id="installments-row" style="display:none;">
              <label for="installments">Nombre d'√©ch√©ances :</label>
              <input type="number" id="installments" min="2" max="24" />
            </div>

            <div class="form-row" id="apply-previous-row" style="display:none;">
              <label style="display:flex;align-items:center;gap:0.6em;font-weight:normal;min-width:0;">
                <input type="checkbox" id="apply-previous" />
                Appliquer aux mois ant√©rieurs
              </label>
            </div>

          <div class="form-row">
            <label for="category">Cat√©gorie :</label>

            <!-- Picker V2 : bouton + pastille -->
            <div class="category-picker-v2">
              <input type="hidden" id="category" name="category" required>
              <button
                type="button"
                class="cat-trigger"
                data-target-input="category"
                data-target-preview="selected-category"
                aria-haspopup="dialog"
                aria-controls="icon-sheet"
                title="Choisir une cat√©gorie">
                <span id="selected-category" class="cat-badge">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
                <span class="cat-current-label">Choisir</span>
              </button>
            </div>
          </div>

            <div class="form-row">
              <label for="description">Description :</label>
              <input type="text" id="description" required />
            </div>

            <div class="form-row">
              <label for="amount">Montant (‚Ç¨) :</label>
              <input type="number" id="amount" step="0.01" required />
            </div>

            <div class="form-row">
              <button type="submit">Ajouter</button>
            </div>
          </form>

        </section>
        <section id="salary-section">
          <h2>Salaire et √©conomies</h2>

          <div class="form-row">
            <label for="salary">Salaire mensuel (‚Ç¨) :</label>
            <input type="number" id="salary" step="0.01" />
          </div>

          <div class="form-row">
            <label for="salary-date">Date de versement :</label>
            <input type="text" id="salary-date" class="date-input" placeholder="jj-mm-aaaa" />
          </div>

          <div class="form-row">
            <label for="savings">√âpargne d√©sir√©e (‚Ç¨) :</label>
            <input type="number" id="savings" step="0.01" />
          </div>

          <!-- Ligne des boutons, align√©e √† droite -->
          <div class="form-row buttons-row">
            <div class="btns-right">
              <button id="refresh-after-salary" class="btn-primary" style="display:none;">Actualiser</button>
              <button id="calculate-saving" class="btn-primary">Calculer le reste √† vivre</button>
            </div>
          </div>

          <p id="saving-result"></p>
        </section>
        <section id="calendar-section">
          <h2>Calendrier</h2>
          <div class="calendar-layout">
            <div class="calendar-wrapper">
              <div class="calendar-nav sticky-nav">
                <!-- S√©lecteur annuel de mois -->
                <div id="month-picker" class="month-picker" style="display:none;"></div>
                <button id="prev-month" aria-label="Mois pr√©c√©dent"><i class="fa-solid fa-arrow-left"></i></button>
                <span id="current-month"></span>
                <button id="next-month" aria-label="Mois suivant"><i class="fa-solid fa-arrow-right"></i></button>
                <button id="go-today" aria-label="Revenir √† aujourd'hui" title="Revenir √† aujourd'hui"><i class="fa-solid fa-calendar-day"></i> Aujourd'hui</button>
              </div>
              <table id="calendar"></table>
              <div id="day-details"></div>
            </div>
            <!-- L√©gende calendrier -->
           <div class="calendar-side-col">
            <aside class="legend-container" id="legend-container">
              <div class="legend-title">L√©gende calendrier</div>
              <ul class="legend-list">
                <li class="legend-item">
                  <span class="legend-color" style="background:var(--color-weekend)" data-var="--color-weekend"></span>
                  <i class="fa-solid fa-rotate-left legend-reset" data-var="--color-weekend" title="Remettre par d√©faut"></i>
                  <span class="legend-label">Week-end</span>
                </li>
                <li class="legend-item">
                  <span class="legend-color" style="background:var(--color-holiday)" data-var="--color-holiday"></span>
                  <i class="fa-solid fa-rotate-left legend-reset" data-var="--color-holiday" title="Remettre par d√©faut"></i>
                  <span class="legend-label">Jour f√©ri√©</span>
                </li>
                <li class="legend-item">
                  <span class="legend-color" style="background:var(--color-today)" data-var="--color-today"></span>
                  <i class="fa-solid fa-rotate-left legend-reset" data-var="--color-today" title="Remettre par d√©faut"></i>
                  <span class="legend-label">Aujourd'hui</span>
                </li>
                <li class="legend-item">
                  <span class="legend-color" style="background:var(--color-primary)" data-var="--color-primary"></span>
                  <i class="fa-solid fa-rotate-left legend-reset" data-var="--color-primary" title="Remettre par d√©faut"></i>
                  <span class="legend-label">S√©lection/Navigation</span>
                </li>
              </ul>
            </aside>
          <!-- R√©capitulatif du mois -->
          <section class="month-summary" id="month-summary">
            <!-- Titre -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6em;">
              <h3 style="margin: 0;">R√©capitulatif du mois</h3>
            </div>

            <!-- NOTE: le bloc "Total du mois" est ins√©r√© ici par le JS (juste apr√®s le H3) -->

            <!-- Contr√¥les d√©plac√©s SOUS le total -->
            <div id="month-controls" style="display:flex; gap:.6rem; align-items:center; margin:.4rem 0 .6rem; color:#27524b;">
              <button id="month-sort-btn" title="Changer le tri" style="background:transparent;border:none;cursor:pointer;font-size:1.3em;color:inherit;">
                <i id="month-sort-icon" class="fa-solid fa-calendar-day"></i>
              </button>
              <label for="group-by-category" style="font-size: 0.9em; display: flex; align-items: center; gap: 0.4em;">
                <input type="checkbox" id="group-by-category" />
                Regrouper par cat√©gorie
              </label>
            </div>

            <!-- Liste -->
            <ul id="month-tx-list"></ul>
          </section>
        </div>
      </div>
        </section>
      </div>
      <!-- Onglet Statistiques -->
      <div id="tab-stats" class="tab-content" style="display:none;">
        <section id="stats-section">
          <h2>Statistiques</h2>
          <!-- ‚ñº Contr√¥le de p√©riode pour les statistiques -->
          <div style="display:flex; align-items:center; gap:.6em; margin-bottom:.6em;">
            <label for="stats-period" style="font-weight:600;">P√©riode :</label>
            <select id="stats-period">
              <option value="day">Aujourd‚Äôhui</option>
              <option value="month" selected>Mois en cours</option>
              <option value="year">Ann√©e en cours</option>
            </select>
          </div>
            <div id="chart-container">
              <div id="pie-chart" style="height:320px;"></div>
            </div>
          <p id="stats-info"></p>
        </section>
      </div>

      <!-- Onglet Historique -->
      <div id="tab-history" class="tab-content" style="display:none;">
        <section id="transactions-section">
          <h2>Liste des transactions</h2>
          <ul id="transactions-list"></ul>
        </section>
      <section id="export-section">
        <h2>Exportation & importation</h2>
        <div style="display:flex; gap:.6rem; flex-wrap:wrap;">
          <button id="export-json">Exporter en JSON</button>
          <button id="export-pdf" title="Exporter en PDF">
            <i class="fa-solid fa-file-pdf"></i> Exporter en PDF
          </button>

          <!-- ‚úÖ Nouveau : Import JSON -->
          <button id="import-json" title="Importer un fichier JSON de transactions">
            <i class="fa-solid fa-file-arrow-up"></i> Importer un JSON
          </button>
          <input id="import-json-file" type="file" accept=".json,application/json" style="display:none;">
        </div>

        <p id="import-hint" class="muted" style="margin-top:.4rem;">
          Tu peux importer un fichier export√© depuis l‚Äôapp ou un JSON compatible (liste de transactions).
        </p>
      </section>
      </div>
      </div><!-- fin main-container finances -->
    </div><!-- fin app-finance -->
    <!-- Sections placeholders pour les autres modules de la multi‚Äëapplication -->
    <section id="app-agenda" class="app-section" style="display:none">
      <!-- Styles SCOP√âS √† l‚ÄôAgenda -->
      <style>
        #app-agenda {
          --ag-surface: var(--color-surface, #fff);
          --ag-surface-2: var(--color-surface-2, #f6fbfd);
          --ag-primary: var(--color-primary, #65b8f7);
          --ag-on: var(--on-surface-strong, #243037);
          --ag-on-muted: var(--on-surface-muted, #5c6a72);
          --ag-border: color-mix(in srgb, var(--ag-on) 8%, transparent);
          --ag-shadow: 0 6px 20px rgba(0,0,0,.06);
          --ag-radius: 14px;
          --ag-radius-pill: 999px;
        }
        #app-agenda .card {
          background: var(--ag-surface);
          border: 1px solid var(--ag-border);
          border-radius: var(--ag-radius);
          box-shadow: var(--ag-shadow);
          padding: 12px;
        }
        #app-agenda .row { display: flex; gap: 12px; flex-wrap: wrap; }
        #app-agenda .col { flex: 1; min-width: 220px; }
        #app-agenda .subtle { color: var(--ag-on-muted); font-size: .95rem; }
        #app-agenda .muted  { color: var(--ag-on-muted); }

        #app-agenda .btn {
          appearance: none; border: 1px solid var(--ag-border); background: var(--ag-surface);
          padding: 8px 12px; border-radius: var(--ag-radius-pill); cursor: pointer;
          transition: transform .05s ease, background .2s, border-color .2s, box-shadow .2s;
          color: var(--ag-on); /* force text/icons to use readable agenda foreground */
        }
        #app-agenda .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.06); }
        #app-agenda .btn:active { transform: translateY(0); }
        #app-agenda .btn.primary {
          background: var(--ag-primary); color: #fff; border-color: transparent;
        }
        #app-agenda .btn.ghost {
          background: color-mix(in srgb, var(--ag-primary) 8%, var(--ag-surface));
          border-color: color-mix(in srgb, var(--ag-primary) 25%, var(--ag-border));
        }
        #app-agenda .btn.danger { border-color: rgba(220, 20, 60, .35); }
        #app-agenda .btn.danger:hover { background: rgba(220, 20, 60, .08); }

        #app-agenda .label { display:block; margin: 0 0 6px; font-weight: 600; color: var(--ag-on); }
        #app-agenda .input, #app-agenda select.input {
          width: 100%; padding: 10px 12px; border-radius: 10px;
          border: 1px solid var(--ag-border); background: var(--ag-surface);
          color: var(--ag-on);
        }
        #app-agenda .select-wrap { position: relative; }
        #app-agenda .select-wrap::after {
          content: "‚ñæ"; position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
          pointer-events: none; color: var(--ag-on-muted);
        }

        #app-agenda .cal-nav { display: flex; align-items: center; gap: 8px; }
        #app-agenda #ag-month { min-width: 190px; text-align: center; font-weight: 700; }
  /* Ensure nav arrows and the "Aujourd'hui" button remain visible on all themes */
  #app-agenda .cal-nav .btn { color: var(--ag-on); }
  #app-agenda .cal-nav .btn.ghost { color: var(--ag-on); }

        #app-agenda #ag-cal-filters { display: flex; flex-wrap: wrap; gap: 8px; }
        #app-agenda .ag-chip {
          display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px;
          background: var(--ag-surface-2); border: 1px solid var(--ag-border);
          border-radius: var(--ag-radius-pill); cursor: pointer;
        }
        #app-agenda .ag-chip input { display: none; }
        #app-agenda .ag-chip .dot { width: 10px; height: 10px; border-radius: 50%; }
        #app-agenda .ag-chip input:checked + .dot { outline: 2px solid color-mix(in srgb, var(--ag-primary) 40%, transparent); outline-offset: 2px; }

        #app-agenda .ag-grid-head {
          display:grid; grid-template-columns:repeat(7,1fr); gap:6px; padding:6px 0; font-weight:600; opacity:.85;
        }
        #app-agenda .ag-grid-body { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
        #app-agenda .ag-day {
          min-height: 120px; border-radius: 14px; padding: 8px;
          background: var(--ag-surface); border: 1px solid var(--ag-border);
          display:flex; flex-direction:column; gap:6px;
        }
        #app-agenda .ag-day.is-selected { outline: 2px solid var(--ag-primary); }
        #app-agenda .badge { font-size: 12px; padding: 2px 8px; border-radius: var(--ag-radius-pill); background: var(--ag-primary); color:#fff; }
        #app-agenda .ag-pill {
          display:flex; align-items:center; gap:6px; font-size:13px; padding:4px 6px;
          border-radius: var(--ag-radius-pill); background: color-mix(in srgb, var(--ag-on) 6%, transparent);
          overflow:hidden; text-overflow:ellipsis; white-space:nowrap; cursor:pointer;
        }

        #app-agenda #ag-quick-form { display:none; align-items:flex-end; gap:8px; }
        #app-agenda #ag-day-list .card { padding: 10px 12px; }

        /* Carte Google */
        #app-agenda .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
        #app-agenda .help { font-size:.9rem; color: var(--ag-on-muted); }
        @media (max-width: 720px){ #app-agenda .grid-2 { grid-template-columns: 1fr; } }

        @media (max-width: 640px) {
          #app-agenda #ag-month { min-width: auto; font-size: 1rem; }
          #app-agenda .cal-nav .btn { padding: 6px 10px; }
          #app-agenda .ag-day { min-height: 96px; padding: 6px; }
          #app-agenda .ag-grid-head { font-size: .9rem; }
          #app-agenda #ag-cal-filters { overflow:auto; padding-bottom: 2px; }
          #app-agenda .ag-chip { padding: 5px 8px; }
        }
      </style>

      <div class="section-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <h2 style="margin:0;">Agenda</h2>
        </div>
        <div class="cal-nav">
          <button id="ag-prev" class="btn ghost" title="Mois pr√©c√©dent">‚óÄ</button>
          <div id="ag-month"></div>
          <button id="ag-next" class="btn ghost" title="Mois suivant">‚ñ∂</button>
          <button id="ag-today" class="btn">Aujourd‚Äôhui</button>
        </div>
      </div>

      <!-- Bandeau r√¥les + filtres -->
      <div class="card" style="margin-bottom:12px;">
        <div class="row" style="align-items:center;">
          <!-- 'Qui suis-je' removed as requested -->
          <div class="col" style="flex:1;">
            <div class="label" style="margin-bottom:6px;">Calendriers visibles</div>
            <div id="ag-cal-filters"></div>
          </div>
        </div>
      </div>

      <!-- Calendrier -->
      <div class="card">
        <div class="ag-grid-head">
          <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
        </div>
        <div id="ag-grid" class="ag-grid-body"></div>
      </div>

      <!-- Panneau jour -->
      <div class="card" style="margin-top:12px;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
          <h3 id="ag-day-title" style="margin:6px 0;">S√©lectionne un jour‚Ä¶</h3>
          <div id="ag-quick-form">
            <div class="select-wrap"><select id="ag-quick-cal" class="input" title="Calendrier"></select></div>
            <input id="ag-quick-title" class="input" placeholder="Nouvel √©v√®nement‚Ä¶" />
            <button id="ag-quick-add" class="btn primary">Ajouter</button>
          </div>
        </div>
        <div id="ag-day-list" class="list" style="display:grid; gap:8px; margin-top:8px;"></div>
        <div id="ag-day-empty" class="muted" style="padding:8px 0;">Aucun √©v√®nement ce jour.</div>
      </div>

    <!-- Organisations & Google -->
    <div class="card" style="margin-top:12px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
        <div>
          <h3 style="margin:6px 0;">Organisations & Google</h3>
          <div class="help">
            Une <b>Organisation</b> = 1 calendrier G√©n√©ral + (optionnel) 1 calendrier par membre. Exemple : Famille, Projet, Colocs.
          </div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="gcal-connect" class="btn primary">Se connecter √† Google</button>
          <button id="gcal-logout" class="btn danger">Se d√©connecter</button>
        </div>
      </div>

      <div id="gcal-status" class="subtle" style="margin-top:6px;">Non connect√©.</div>

      <div class="grid-2" style="margin-top:12px;">
        <!-- Cr√©er / g√©rer -->
        <div>
          <div class="label">Cr√©er une organisation</div>
          <input id="org-name" class="input" placeholder="Nom de l‚Äôorganisation (ex: Famille Martin, Projet Alpha)" style="width:100%; max-width:480px;">
          <div style="height:8px;"></div>

          <div>
            <div class="label">Membres (e-mails)</div>
            <div style="display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap;">
              <textarea id="org-members" class="input" rows="3"
                        placeholder="S√©parez par virgules ou retours √† la ligne"
                        style="width:100%; max-width:480px;"></textarea>
              <button id="org-invite" class="btn" disabled title="Inviter ces e-mails √† l‚Äôorganisation">
                Inviter les membres
              </button>
            </div>
          </div>

          <div style="margin:8px 0; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <label style="display:flex; gap:6px; align-items:center;">
              <input type="checkbox" id="org-create-personals" checked>
              <span>Cr√©er un calendrier personnel par membre</span>
            </label>
            <label style="display:flex; gap:6px; align-items:center;">
              <input type="checkbox" id="org-send-invites" checked>
              <span>Envoyer un e-mail d‚Äôinvitation</span>
            </label>
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button id="org-create-btn" class="btn">Cr√©er l‚Äôorganisation</button>
            <button id="org-refresh" class="btn ghost">Actualiser mes organisations</button>
          </div>
          <div class="help" style="margin-top:6px;">
            Le compte connect√© est <b>propri√©taire</b> des agendas de l‚Äôorganisation.
          </div>
        </div>

        <!-- Mes organisations / Partag√©es -->
        <div>
          <div style="display:flex; gap:12px; align-items:center; justify-content:space-between;">
            <div class="label">Organisations visibles</div>
            <div style="display:flex; gap:8px;">
              <button id="org-import" class="btn ghost" title="Affiche (importe) les √©v√®nements du mois visible pour les organisations coch√©es">Afficher le mois (organisations coch√©es)</button>
              <button id="org-import-primary" class="btn ghost" title="Copie votre calendrier principal Google dans le G√©n√©ral de l‚Äôorganisation s√©lectionn√©e (mois visible)">R√©cup√©rer mon calendrier principal ‚Üí G√©n√©ral</button>
            </div>
          </div>

          <div style="margin-top:6px;">
              <div style="font-weight:600; margin:6px 0;">Mes organisations (propri√©taire)</div>

              <!-- Invitations re√ßues / notifications (local-first) -->
              <div id="org-invitations" style="margin-top:8px;">
                <div style="font-weight:600; margin:6px 0;">Invitations</div>
                <div id="org-invite-notifs" class="muted" style="margin-bottom:6px;">Aucune invitation.</div>
                <div id="org-invite-list" class="list"></div>
              </div>
            <div id="org-owned-list" class="list"></div>

            <div style="height:10px;"></div>

            <div style="font-weight:600; margin:6px 0;">Organisations partag√©es avec moi</div>
            <div id="org-shared-list" class="list"></div>
          </div>
        </div>
      </div>
    </div>
    </section>
    <div id="app-courses" class="app-section" style="display:none;">
      <section class="placeholder-section">
        <h2>Courses</h2>
        <p>Ce module sera bient√¥t disponible.</p>
      </section>
    </div>
    <div id="app-gamelles" class="app-section" style="display:none;">
      <section class="placeholder-section">
        <h2>Gamelles</h2>
        <p>Ce module sera bient√¥t disponible.</p>
      </section>
    </div>
    <div id="app-taches" class="app-section" style="display:none;">
      <section class="placeholder-section">
        <h2>T√¢ches perso / pro</h2>
        <p>Ce module sera bient√¥t disponible.</p>
      </section>
    </div>
    <div id="app-sante" class="app-section" style="display:none;">
      <section class="placeholder-section">
        <h2>Sant√©</h2>
        <p>Ce module sera bient√¥t disponible.</p>
      </section>
    </div>
  </main>
  <!-- Modale Ajout rapide (calendrier) -->
<div id="modal-add-transaction" class="modal-bg" style="display:none;">
  <div class="modal-content">
    <h3 style="margin-top:0; color:#27524b;">Nouvelle transaction rapide</h3>
      <form id="add-transaction-form" novalidate>
        <div class="form-row">
          <label for="add-description">Description :</label>
          <input type="text" id="add-description" required />
        </div>

        <div class="form-row">
          <label for="add-date">Date :</label>
          <input type="text" id="add-date" class="date-input" placeholder="jj-mm-aaaa" required />
        </div>

        <div class="form-row">
          <label for="add-amount">Montant (‚Ç¨) :</label>
          <input type="number" id="add-amount" step="0.01" required />
        </div>

        <div class="form-row">
          <label for="add-type">Type :</label>
          <select id="add-type" required>
            <option value="expense">D√©pense</option>
            <option value="income">Revenu</option>
          </select>
        </div>

        <!-- üìå AJOUT ‚Äî Options de r√©currence (ajout rapide) -->
        <div class="form-row">
          <label for="add-recurrence">R√©currence :</label>
          <select id="add-recurrence">
            <option value="none">Aucune</option>
            <option value="monthly">Mensuelle</option>
            <option value="yearly">Annuelle</option>
            <option value="installments">Paiement en X fois</option>
          </select>
        </div>

        <div class="form-row" id="add-end-row">
          <label for="add-until">Jusqu‚Äô√† :</label>
          <input type="text" id="add-until" class="date-input" placeholder="jj-mm-aaaa" />
        </div>

        <div class="form-row" id="add-installments-row" style="display:none;">
          <label for="add-installments">Nombre d'√©ch√©ances :</label>
          <input type="number" id="add-installments" min="2" max="24" />
        </div>

        <div class="form-row" id="add-apply-previous-row" style="display:none;">
          <label style="display:flex;align-items:center;gap:0.6em;font-weight:normal;min-width:0;">
            <input type="checkbox" id="add-apply-previous" />
            Appliquer aux mois ant√©rieurs
          </label>
        </div>

        <div class="form-row">
          <label for="add-category">Cat√©gorie :</label>
            <!-- === PICKER Cat√©gorie (formulaire principal) === -->
        <div class="category-picker-v2">
          <input type="hidden" id="add-category" name="category" required>
          <button
            type="button"
            class="cat-trigger"
            data-target-input="add-category"
            data-target-preview="add-selected-category"
            aria-haspopup="dialog"
            aria-controls="icon-sheet"
            title="Choisir une cat√©gorie">
            <span id="add-selected-category" class="cat-badge">
              <i class="fa-regular fa-circle-question"></i>
            </span>
            <span class="cat-current-label">Choisir</span>
          </button>
        </div><div style="margin-top:1.5em; display:flex; justify-content:flex-end; gap:1em;">
          <button type="submit" style="background:#27524b;color:#fff;padding:0.5em 1.2em;border:none;border-radius:4px;cursor:pointer;">Ajouter</button>
          <button type="button" id="add-cancel-btn" style="background:#d32f2f;color:#fff;padding:0.5em 1.2em;border:none;border-radius:4px;cursor:pointer;">Annuler</button>
        </div>
      </form>
  </div>
</div>

<!-- Modale Edition Historique (avec choix de cat√©gorie) -->
  <div id="modal-edit-transaction" class="modal-bg" style="display:none;">
    <div class="modal-content" style="max-width:680px;">
      <h3 style="margin-top:0;">Modifier la transaction</h3>

      <form id="edit-transaction-form" novalidate>
        <input type="hidden" id="edit-id" />

        <div class="form-row">
          <label for="edit-description">Description :</label>
          <input type="text" id="edit-description" required />
        </div>

        <div class="form-row">
          <label for="edit-amount">Montant (‚Ç¨) :</label>
          <input type="number" id="edit-amount" step="0.01" required />
        </div>

        <div class="form-row">
          <label for="edit-date">Date :</label>
          <input type="text" id="edit-date" class="date-input" placeholder="jj-mm-aaaa" required />
        </div>

        <div class="form-row">
          <label for="edit-type">Type :</label>
          <select id="edit-type" required>
            <option value="expense">D√©pense</option>
            <option value="income">Revenu</option>
          </select>
        </div>

        <!-- ‚úÖ Cat√©gorie : bouton "Choisir" + aper√ßu ic√¥ne -->
        <div class="form-row">
          <label for="edit-category">Cat√©gorie :</label>
          <div class="category-picker-v2">
            <input type="hidden" id="edit-category" name="category" required>
            <button
              type="button"
              class="cat-trigger"
              data-target-input="edit-category"
              data-target-preview="edit-selected-category"
              aria-haspopup="dialog"
              aria-controls="icon-sheet"
              title="Choisir une cat√©gorie">
              <span id="edit-selected-category" class="cat-badge">
                <i class="fa-regular fa-circle-question"></i>
              </span>
              <span class="cat-current-label">Choisir</span>
            </button>
          </div>
        </div>

        <div class="form-row">
          <label for="edit-recurrence">R√©currence :</label>
          <select id="edit-recurrence">
            <option value="none">Aucune</option>
            <option value="monthly">Mensuelle</option>
            <option value="yearly">Annuelle</option>
            <option value="installments">Paiement en X fois</option>
          </select>
        </div>

        <div class="form-row" id="edit-end-row" style="display:none;">
          <label for="edit-until">Jusqu‚Äô√† :</label>
          <input type="text" id="edit-until" class="date-input" placeholder="jj-mm-aaaa" />
        </div>

        <div class="form-row" id="edit-installments-row" style="display:none;">
          <label for="edit-installments">Nombre d‚Äô√©ch√©ances :</label>
          <input type="number" id="edit-installments" min="2" max="24" />
        </div>

        <div class="form-row" id="edit-apply-previous-row" style="display:none;">
          <label style="display:flex;align-items:center;gap:0.6em;font-weight:normal;min-width:0;">
            <input type="checkbox" id="edit-apply-previous" />
            Appliquer aux mois ant√©rieurs
          </label>
        </div>

        <hr style="margin:1em 0; border:none; border-top:1px solid #ddd;">

        <div class="form-row">
          <label for="edit-stats-period">Afficher les statistiques par :</label>
          <select id="edit-stats-period">
            <option value="day">Jour (aujourd‚Äôhui)</option>
            <option value="month" selected>Mois</option>
            <option value="year">Ann√©e</option>
          </select>
        </div>

        <div style="margin-top:1em;display:flex;gap:.6em;justify-content:flex-end;flex-wrap:wrap;">
          <button type="button" id="edit-delete-btn" style="background:#d32f2f;color:#fff;border:none;border-radius:6px;padding:.5em 1em;cursor:pointer;">Supprimer la transaction</button>
          <span style="flex:1 1 auto;"></span>
          <button type="button" id="edit-cancel-btn" style="background:#777;color:#fff;border:none;border-radius:6px;padding:.5em 1em;cursor:pointer;">Annuler</button>
          <button type="submit" style="background:#27524b;color:#fff;border:none;border-radius:6px;padding:.5em 1em;cursor:pointer;">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- === AJOUT : Modale Export PDF === -->
<div id="export-pdf-modal" class="modal-bg" style="display:none;">
  <div class="modal-content" style="max-width:680px;">
    <h3 style="margin-top:0;">Exporter en PDF</h3>

    <div class="export-grid">
      <label class="export-opt">
        <input type="checkbox" id="exp-calendar" checked>
        <span class="opt-icon"><i class="fa-solid fa-calendar-days"></i></span>
        <span class="opt-text">
          <strong>Calendrier</strong>
          <small>Le mois courant avec les marquages</small>
        </span>
      </label>

      <label class="export-opt">
        <input type="checkbox" id="exp-month" checked>
        <span class="opt-icon"><i class="fa-solid fa-list"></i></span>
        <span class="opt-text">
          <strong>R√©capitulatif du mois</strong>
          <small>Transactions group√©es / tri√©es</small>
        </span>
      </label>

      <label class="export-opt">
        <input type="checkbox" id="exp-stats" checked>
        <span class="opt-icon"><i class="fa-solid fa-chart-pie"></i></span>
        <span class="opt-text">
          <strong>Graphiques</strong>
          <small>La section Statistiques (camembert)</small>
        </span>
      </label>

      <label class="export-opt">
        <input type="checkbox" id="exp-history">
        <span class="opt-icon"><i class="fa-solid fa-clock-rotate-left"></i></span>
        <span class="opt-text">
          <strong>Historique</strong>
          <small>Liste des transactions</small>
        </span>
      </label>
    </div>

    <div class="export-meta">
      <label for="export-filename" style="font-weight:700; color:#366f8c;">Nom du fichier</label>
      <input type="text" id="export-filename" value="finances-{{YYYY-MM}}.pdf" />
      <div class="export-tips">
        Astuce : ouvre l‚Äôonglet <em>Statistiques</em> juste avant d‚Äôexporter pour avoir un graphe √† jour.
      </div>
    </div>

    <div style="display:flex; gap:.6rem; justify-content:flex-end; margin-top:1rem;">
      <button type="button" id="export-pdf-cancel" class="btn-ghost">Annuler</button>
      <button type="button" id="export-pdf-run" class="btn-primary">
        <i class="fa-solid fa-file-arrow-down"></i> G√©n√©rer le PDF
      </button>
    </div>
  </div>
</div>

<!-- Overlay d'authentification -->
<div id="auth-overlay" class="modal-bg" style="display:none;">
  <div class="modal-content">
    <h3 id="auth-title">Authentification</h3>
    <form id="auth-form" novalidate>
      <div class="form-row">
        <label for="auth-password">Mot de passe :</label>
        <input type="password" id="auth-password"
               autocomplete="current-password" required />
      </div>

      <div class="form-row" id="auth-confirm-row" style="display:none;">
        <label for="auth-password-confirm">Confirmer :</label>
        <!-- ATTENTION : PAS de required ici -->
        <input type="password" id="auth-password-confirm"
               autocomplete="new-password" />
      </div>

      <div style="text-align:right;">
        <button type="submit" id="auth-submit-btn">Valider</button>
      </div>
    </form>
  </div>
</div>

<!-- Bottom sheet ‚Äî Icon Picker V2 -->
<div id="icon-sheet" class="sheet" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="sheet__backdrop"></div>
  <div class="sheet__panel" role="document" tabindex="-1">
    <div class="sheet__grab"></div>
    <div class="sheet__header">
      <h3 class="sheet__title">Choisir une ic√¥ne</h3>
      <button class="sheet__close" type="button" aria-label="Fermer"
              onclick="window.__closeIconSheet && window.__closeIconSheet()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="sheet__toolbar">
      <div class="cp-search">
        <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
        <input id="ip-search" type="text" placeholder="Rechercher (ex. loyer, courses, essence‚Ä¶)" autocomplete="off">
      </div>
      <div id="ip-chips" class="cp-chips" aria-label="Cat√©gories"></div>
    </div>

    <div id="ip-grid" class="ip-grid" aria-live="polite"></div>

    <div class="sheet__footer">
      <button id="ip-cancel" class="btn-ghost" type="button"
              onclick="window.__closeIconSheet && window.__closeIconSheet()">
        Annuler
      </button>
      <button id="ip-validate" class="btn-primary" type="button" disabled
        onclick="window.__applyIconSelection && window.__applyIconSelection()">
        Valider
      </button>
    </div>
  </div>
</div>

<script>
  (function(){
    const btn = document.getElementById('profileBtn');
    const dd  = document.getElementById('profileDropdown');
    if (!btn || !dd) return;
    btn.addEventListener('click', () => {
      const open = dd.style.display === 'block';
      dd.style.display = open ? 'none' : 'block';
      btn.setAttribute('aria-expanded', String(!open));
      dd.setAttribute('aria-hidden', String(open));
    });
    // Option: fermer au clic hors du menu
    document.addEventListener('click', (e) => {
      if (!dd.contains(e.target) && !btn.contains(e.target)) {
        if (dd.style.display === 'block') {
          dd.style.display = 'none';
          btn.setAttribute('aria-expanded', 'false');
          dd.setAttribute('aria-hidden', 'true');
        }
      }
    });
  })();
</script>

<!-- Bouton d'installation -->
<button id="installBtn" style="display:none;">Installer l‚Äôapp</button>

<script>
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById('installBtn');
  btn.style.display = 'inline-block';
  btn.onclick = async () => {
    btn.disabled = true;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
    btn.style.display = 'none';
  };
});
</script>

<!-- jsPDF & html2canvas pour l'export PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Script principal (charg√© apr√®s le parsing du HTML) -->
<script type="module" src="script.js"></script>
<script>
/* Recovery shim ‚Äî nav multi-app + coupe tout overlay bloquant,
   fonctionne m√™me si script.js a plant√©. */
(() => {
  function killOverlays(){
    ['icon-sheet','auth-overlay'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('is-open');
      el.setAttribute('aria-hidden','true');
      el.style.display = 'none';
      el.style.pointerEvents = 'none';
    });
  }

  function bindNav(){
    const btns = Array.from(document.querySelectorAll('.app-btn'));
    const sections = Array.from(document.querySelectorAll('.app-section'));
    if (!btns.length || !sections.length) return;

    const allowed = new Set(btns.map(b => b.dataset.app));
    function show(app){
      if (!allowed.has(app)) app = btns[0].dataset.app;
      btns.forEach(b => b.classList.toggle('active', b.dataset.app === app));
      sections.forEach(sec => sec.style.display = 'none');
      const target = document.getElementById('app-'+app);
      if (target) target.style.display = 'block';
      try { localStorage.setItem('app:last', app); } catch {}
      try { history.replaceState(null,'','#'+app); } catch { location.hash = app; }
    }

    btns.forEach(b => b.addEventListener('click', () => show(b.dataset.app), { passive:true }));

    // Choix initial : hash > localStorage > premier bouton
    const raw = (location.hash || '').replace(/^#/,'');
    const fromHash = raw.startsWith('app=') ? raw.slice(4) : raw;
    const start = allowed.has(fromHash)
      ? fromHash
      : (localStorage.getItem('app:last') || btns[0].dataset.app);
    show(start);
  }

  window.addEventListener('DOMContentLoaded', () => {
    killOverlays();
    bindNav();
  });
})();
</script>

<!-- === Modal: choix de la transaction √† modifier === -->
<div id="modal-pick-transaction" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-content" style="max-width:560px">
    <div class="modal-header">
      <h5 class="modal-title">Quelle transaction modifier ?</h5>
      <button type="button" class="modal-close" id="mp-close" aria-label="Fermer">√ó</button>
    </div>
    <div class="modal-body">
      <div id="mp-list" class="mp-list"></div>
    </div>
    <div class="modal-footer">
      <button type="button" id="mp-cancel" class="btn-secondary">Annuler</button>
      <button type="button" id="mp-confirm" class="btn-primary" disabled>√âditer</button>
    </div>
  </div>
</div>
</body>
</html>
